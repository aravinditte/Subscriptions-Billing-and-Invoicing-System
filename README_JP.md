# サブスクリプション課金・請求システム

本プロジェクトは、**日本の企業で求められるバックエンド設計力**を示すために作られた、
本番レベルの **サブスクリプション課金・請求システム** です。

CRUD ではなく、**正確性・信頼性・設計力** を重視しています。

---

## 🚀 主な機能

- サブスクリプション管理（トライアル・有効・支払い遅延・解約）
- 定期課金（バックグラウンドジョブ）
- 請求書の自動生成（不変データ）
- モック決済ゲートウェイ（成功・失敗のシミュレーション）
- 支払い失敗時のリトライ処理
- 監査ログ（すべての重要操作）
- ドメイン駆動設計（DDD）
- 単体・統合・E2E テスト
- Docker による実行環境

---

## 🏗️ アーキテクチャ概要

```
API（FastAPI）
  ↓
サービス層
  ↓
ドメイン層（ビジネスロジック）
  ↓
PostgreSQL
```

非同期処理は **Celery + Redis** を使用しています。

---

## 🧠 このプロジェクトの強み

- サブスクリプション状態をステートマシンで管理
- 二重請求を防ぐ設計（冪等性）
- 請求書は不変（監査・会計対応）
- ビジネスロジックと API の完全分離

日本のバックエンド面接で評価される要素を重視しています。

---

## ⚙️ 技術スタック

- 言語: Python
- フレームワーク: FastAPI
- DB: PostgreSQL
- ORM: SQLAlchemy + Alembic
- 非同期処理: Celery
- Broker: Redis
- テスト: Pytest
- 環境構築: Docker / Docker Compose

---

## ▶️ 実行方法

### 1. 環境変数設定

```bash
cp .env.example .env
```

### 2. 起動

```bash
make up
```

### 3. マイグレーション

```bash
make migrate
```

### 4. 初期データ投入

```bash
make seed
```

### 5. 管理ユーザー作成

```bash
make admin
```

### 6. API ドキュメント

http://localhost:8000/docs

---

## 🧪 テスト実行

```bash
make test
```

---

## 📂 ディレクトリ構成

```
app/
 ├── api/        # API層
 ├── core/       # 設定・DB
 ├── domain/     # ドメインロジック
 ├── services/   # ユースケース
 ├── tasks/      # 非同期ジョブ
 ├── utils/      # ユーティリティ
 └── exceptions/ # 例外定義
```

---

## 💼 面接での説明ポイント

- なぜ請求書は不変なのか
- 冪等性による二重課金防止
- ステートマシンを使う理由
- 決済失敗時の安全な処理
- 金融システムにおける監査ログの重要性

---

## 📌 作者

日本向けバックエンド職を想定した、
**実務レベルの設計を重視したポートフォリオプロジェクト**。
